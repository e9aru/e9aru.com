<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>e9aru.com</title>
    <style>
      :root {
        --dark: #222;
        --light: #eee;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-size: 18px;
        font-family: "Courier New", Courier, monospace;
        letter-spacing: 0.12em;
        line-height: 1.6;
        margin: 0;
        background: var(--light);
      }
      body,
      body * {
        color: var(--dark);
        border-color: var(--dark);
      }
      [data-dark-mode],
      [data-dark-mode] * {
        color: var(--light);
        border-color: var(--light);
      }
      [data-dark-mode] {
        background: var(--dark);
      }
      a {
        text-decoration: none;
        border-bottom: 1px dashed;
      }
      main {
        background: none;
        display: flex;
        width: 100vw;
        height: 100vh;
        flex-direction: row;
        flex-wrap: wrap;
        position: relative;
      }
      main > * {
        margin: auto;
        width: 100%;
      }
      h1 {
        font-size: 3rem;
      }
      footer {
        margin-bottom: 0;
        text-align: center;
        line-height: 1;
        font-size: 0.8rem;
        padding: 0.5rem;
      }
      #bg {
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
      }
      #darkMode {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        font-size: 1.2rem;
        line-height: 1;
        width: 2em;
        height: 2em;
        background: transparent;
        border: 2px solid;
        border-radius: 200%;
        outline: none;
        cursor: pointer;
        z-index: 2;
      }
      #darkMode::after {
        content: "☀";
      }
      [data-dark-mode] #darkMode:after {
        content: "☾";
      }
    </style>
  </head>
  <body>
    <canvas id="bg"></canvas>
    <button id="darkMode"></button>
    <main>
      <h1>Hello</h1>
      <p></p>
      <footer>
        Created with ❤<br /><a
          target="_blank"
          href="https://github.com/e9aru/e9aru.com"
          >Check code on Github</a
        >
      </footer>
    </main>
    <script>
      "use strict"
      // ;(() => {
      const dpr = window.devicePixelRatio || 1
      const dark = getComputedStyle(document.body)
        .getPropertyValue("--dark")
        .trim()
      const light = getComputedStyle(document.body)
        .getPropertyValue("--light")
        .trim()
      const ctx = document.getElementById("bg").getContext("2d")
      const initCtx = () => {
        Particle.pool.length = 0

        ctx.w = ctx.canvas.width = ctx.canvas.clientWidth * dpr
        ctx.h = ctx.canvas.height = ctx.canvas.clientHeight * dpr

        ctx.clearRect(0, 0, ctx.w, ctx.h)
        ctx.font = "bold 240px sans-serif"
        ctx.fillStyle = "red"
        ctx.textAlign = "center"
        ctx.fillText("ꑀꁅꁲꌅꌈ", ctx.w / 2, ctx.h / 2)

        const data = ctx
          .getImageData(0, 0, ctx.w, ctx.h)
          .data.filter((v, idx) => !((idx + 1) % 4))

        data.forEach((v, idx) => {
          if (!(idx % ~~(ctx.w / 100)) && v > 250)
            new Particle(null, null, ~~(idx % ctx.w), ~~(idx / ctx.w))
        })
        // ctx.clearRect(0, 0, ctx.w, ctx.h)

        console.log("Spawned:", Particle.pool.length)

        const render = () => {
          requestAnimationFrame(render)

          if (document.hasFocus()) {
            ctx.clearRect(0, 0, ctx.w, ctx.h)
            Particle.pool.forEach((p) => p.render())
          }
        }

        render()
      }
      const isDarkMode = () => localStorage.getItem("darkMode") === "true"
      const updateDOM = (full = true) => {
        document.body[isDarkMode() ? "setAttribute" : "removeAttribute"](
          "data-dark-mode",
          ""
        )

        full && initCtx()
      }

      class Particle {
        static pool = []

        constructor(x, y, dx, dy) {
          Particle.pool.push(this)

          this.wait = 110 + Math.random() * 190
          this.x = x || Math.random() * ctx.w
          this.y = y || Math.random() * ctx.h
          this._dx = dx || this.x
          this._dy = dy || this.y
          this.dx = this._dx
          this.dy = this._dy
          this.ax = 0
          this.ay = 0
          this.vx = 0
          this.vy = 0
          this.s = 2 * dpr + Math.random() * 4
        }

        render() {
          const drag = 0.92 + Math.random() * 0.08
          const mag = Math.min(
            Math.abs(this.dx - this.x),
            Math.abs(this.dy - this.y)
          )

          this.wait--

          if (this.wait < 0) {
            this.ax = (this.dx - this.x) / 1000
            this.ay = (this.dy - this.y) / 1000
          }

          if (mag < 2) {
            const angle = Math.random() * Math.PI * 2
            const radius = Math.random() * (1500 / this.s ** 3)
            this.dx = this._dx + Math.cos(angle) * radius
            this.dy = this._dy + Math.sin(angle) * radius
          }

          if (this.dx - this.x) this.vx += this.ax
          this.vy += this.ay
          this.vx *= drag
          this.vy *= drag

          this.x += this.vx
          this.y += this.vy

          ctx.fillStyle = isDarkMode() ? light : dark
          ctx.fillRect(this.x - this.s / 2, this.y - this.s / 2, this.s, this.s)
        }
      }

      // Event listeners
      window.addEventListener("resize", updateDOM)
      // window.addEventListener("mousemove", (e) => {
      //   const pixel = ctx.getImageData(e.clientX * dpr, e.clientY * dpr, 1, 1)
      //   console.log(e.clientX, pixel.data)
      // })
      document.getElementById("darkMode").addEventListener("click", () => {
        localStorage.setItem("darkMode", !isDarkMode())
        updateDOM(false)
      })

      // Run
      updateDOM()
      // })()
    </script>
  </body>
</html>
